import asyncio
import os
import datetime
import httpx
import random
from telegram import Update
from telegram.ext import Application, CommandHandler, ContextTypes, MessageHandler, filters
from flask import Flask
import threading
import pytz

# –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ú–æ—Å–∫–≤—ã
moscow_tz = pytz.timezone('Europe/Moscow')

# Flask –¥–ª—è Render
app = Flask(__name__)

@app.route('/')
def index():
    return 'Bot is running!'

def run_flask():
    app.run(host='0.0.0.0', port=10000)

# –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –∏ ID —á–∞—Ç–∞
BOT_TOKEN = os.environ.get('BOT_TOKEN', 'YOUR_BOT_TOKEN_HERE')
CHAT_ID = os.environ.get('CHAT_ID', '-1001234567890')

# –¢–µ–º—ã –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
DAY_THEMES = {
    "Monday": {
        "name": "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫",
        "theme": "üéµ –î–µ–Ω—å –º—É–∑—ã–∫–∏",
        "message": "–í–∫–ª—é—á–∞–π –ª—é–±–∏–º—ã–π –ø–ª–µ–π–ª–∏—Å—Ç –∏ –±–µ–≥–∏ –≤ —Ä–∏—Ç–º–µ!"
    },
    "Tuesday": {
        "name": "–í—Ç–æ—Ä–Ω–∏–∫",
        "theme": "üêæ –î–µ–Ω—å –ø–∏—Ç–æ–º—Ü–µ–≤",
        "message": "–í–æ–∑—å–º–∏ —Å–≤–æ–µ–≥–æ –ø—É—à–∏—Å—Ç–æ–≥–æ –¥—Ä—É–≥–∞ –Ω–∞ –ø—Ä–æ–±–µ–∂–∫—É!"
    },
    "Wednesday": {
        "name": "–°—Ä–µ–¥–∞",
        "theme": "ü§ù –î–µ–Ω—å –¥–æ–±—Ä—ã—Ö –¥–µ–ª",
        "message": "–°–µ–≥–æ–¥–Ω—è –ø–æ–º–æ–≥–∞–µ–º –¥—Ä—É–≥–∏–º –±–µ–≥—É–Ω–∞–º –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ!"
    },
    "Thursday": {
        "name": "–ß–µ—Ç–≤–µ—Ä–≥",
        "theme": "üçî –î–µ–Ω—å –µ–¥—ã",
        "message": "–ü–æ—Å–ª–µ –±–µ–≥–∞ –∑–∞—Å–ª—É–∂–µ–Ω–Ω—ã–π –æ–±–µ–¥ –∂–¥—ë—Ç —Ç–µ–±—è!"
    },
    "Friday": {
        "name": "–ü—è—Ç–Ω–∏—Ü–∞",
        "theme": "üì∏ –î–µ–Ω—å —Å–µ–ª—Ñ–∏",
        "message": "–°–¥–µ–ª–∞–π –∫—Ä—É—Ç–æ–µ —Ñ–æ—Ç–æ –Ω–∞ –ø—Ä–æ–±–µ–∂–∫–µ –¥–ª—è –∏–Ω—Å—Ç–∞–≥—Ä–∞–º–∞!"
    },
    "Saturday": {
        "name": "–°—É–±–±–æ—Ç–∞",
        "theme": "üò¢ –î–µ–Ω—å –Ω—ã—Ç—å—è",
        "message": "–ú–æ–∂–Ω–æ –Ω–µ–º–Ω–æ–≥–æ –ø–æ–ø–ª–∞–∫–∞—Ç—å –≤ –ø–æ–¥—É—à–∫—É –ø–æ—Å–ª–µ –±–µ–≥–∞..."
    },
    "Sunday": {
        "name": "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ",
        "theme": "üé® –î–µ–Ω—å –Ω—é–¥—Å–æ–≤",
        "message": "–î–µ–Ω—å –¥–ª—è —Å–º–µ–ª—ã—Ö —Ä–µ—à–µ–Ω–∏–π –∏ –Ω–æ–≤—ã—Ö —Ä–µ–∫–æ—Ä–¥–æ–≤!"
    }
}

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–≥–æ–¥—ã —á–µ—Ä–µ–∑ Open-Meteo API
async def get_weather(city: str) -> str:
    """–ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â—É—é –ø–æ–≥–æ–¥—É"""
    coordinates = {
        '–º–æ—Å–∫–≤–∞': {'lat': 55.7558, 'lon': 37.6173},
        '–ø–∏—Ç–µ—Ä': {'lat': 59.9343, 'lon': 30.3351}
    }
    
    city_lower = city.lower()
    if city_lower not in coordinates:
        return "üå°Ô∏è –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
    
    coords = coordinates[city_lower]
    url = "https://api.open-meteo.com/v1/forecast"
    params = {
        'latitude': coords['lat'],
        'longitude': coords['lon'],
        'current_weather': 'true',
        'temperature_unit': 'celsius',
        'windspeed_unit': 'kmh'
    }
    
    try:
        async with httpx.AsyncClient() as client:
            response = await client.get(url, params=params, timeout=10.0)
            if response.status_code == 200:
                data = response.json()
                current = data.get('current_weather', {})
                temp = current.get('temperature', 0)
                wind = current.get('windspeed', 0)
                
                if temp > 20:
                    emoji = "‚òÄÔ∏è"
                elif temp > 10:
                    emoji = "üå§Ô∏è"
                elif temp > 0:
                    emoji = "üå•Ô∏è"
                elif temp == 0:
                    emoji = "üå®Ô∏è"
                else:
                    emoji = "‚ùÑÔ∏è"
                
                return f"{emoji} {temp}¬∞C, –≤–µ—Ç–µ—Ä {wind} –∫–º/—á"
            return "üå°Ô∏è –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø–æ–≥–æ–¥—ã: {e}")
        return "üå°Ô∏è –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"

# –°–ª—É—á–∞–π–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
def get_greeting(weather_moscow: str) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ"""
    greetings = [
        "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, –±–µ–≥—É–Ω—ã! üèÉ‚Äç‚ôÇÔ∏è\n–°–µ–≥–æ–¥–Ω—è –æ—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏!",
        "–£—Ç—Ä–æ –¥–æ–±—Ä–æ–µ! üëü\n–ö—Ä–æ—Å—Å–æ–≤–∫–∏ –Ω–∞–≥–æ—Ç–æ–≤–µ? –ù–æ–≥–∏ –∂–¥—É—Ç!",
        "–° –¥–æ–±—Ä—ã–º —É—Ç—Ä–æ–º! üåÖ\n–°–µ–≥–æ–¥–Ω—è –ø–æ–±–µ–∂–∏–º –∏–ª–∏ –∫–∞–∫?",
        "–£—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–∏–≤–µ—Ç! ‚òï\n–ö–æ—Ñ–µ –≤—ã–ø–∏—Ç, –º–æ–∂–Ω–æ –∏ –±–µ–∂–∞—Ç—å!",
        "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, —á–µ–º–ø–∏–æ–Ω—ã! üèÜ\n–ñ–¥—É –Ω–∞ —É—Ç—Ä–µ–Ω–Ω–µ–π –ø—Ä–æ–±–µ–∂–∫–µ!",
        "–° —É—Ç—Ä–∞ –ø–æ—Ä–∞–Ω—å—à–µ! üåû\n–õ—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –±–µ–≥–∞ —É–∂–µ –Ω–∞—Å—Ç—É–ø–∏–ª–æ!",
    ]
    
    try:
        import re
        match = re.search(r'(-?\d+)¬∞C', weather_moscow)
        if match:
            temp = int(match.group(1))
        else:
            temp = 10
    except:
        temp = 10
    
    if temp < 5:
        cold_greetings = [
            "–ë—Ä—Ä—Ä, –¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ! ü•∂\n–°–µ–≥–æ–¥–Ω—è —Ö–æ–ª–æ–¥–Ω–æ, –Ω–æ –º—ã –Ω–µ —Å–¥–∞—ë–º—Å—è!",
            "–ú–æ—Ä–æ–∑–Ω–æ–µ —É—Ç—Ä–æ! ‚ùÑÔ∏è\n–û–¥–µ–≤–∞–π—Ç–µ—Å—å —Ç–µ–ø–ª–µ–µ, –±–µ–≥—É–Ω—ã!",
            "–•–æ–ª–æ–¥–Ω–æ–µ —É—Ç—Ä–æ, –Ω–æ —Ç—ë–ø–ª—ã–µ —Å–µ—Ä–¥—Ü–∞! ‚ù§Ô∏è\n–°–µ–≥–æ–¥–Ω—è –±–µ–∂–∏–º, —á—Ç–æ–±—ã —Å–æ–≥—Ä–µ—Ç—å—Å—è!",
        ]
        greetings.extend(cold_greetings)
    elif temp > 25:
        warm_greetings = [
            "–ñ–∞—Ä–∫–æ–µ —É—Ç—Ä–æ! üî•\n–ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤–æ–¥—É —Å —Å–æ–±–æ–π!",
            "–°–æ–ª–Ω–µ—á–Ω–æ–µ —É—Ç—Ä–æ! ‚òÄÔ∏è\n–ò–¥–µ–∞–ª—å–Ω–∞—è –ø–æ–≥–æ–¥–∞ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –¥–∏—Å—Ç–∞–Ω—Ü–∏–π!",
        ]
        greetings.extend(warm_greetings)
    
    return random.choice(greetings)

# –ö–æ–º–∞–Ω–¥–∞ /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start"""
    user_name = update.message.from_user.first_name
    welcome_text = f"–ü—Ä–∏–≤–µ—Ç, {user_name}! üëã\n\n–Ø –±–æ—Ç –¥–ª—è –±–µ–≥–æ–≤–æ–≥–æ —á–∞—Ç–∞. –ö–∞–∂–¥–æ–µ —É—Ç—Ä–æ –≤ 06:00 –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ —è –±—É–¥—É –ø–∏—Å–∞—Ç—å –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–≥–æ–¥–æ–π. –¢–∞–∫–∂–µ –±—É–¥—É –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞!\n\n–£–¥–∞—á–Ω—ã—Ö –ø—Ä–æ–±–µ–∂–µ–∫! üèÉ‚Äç‚ôÇÔ∏è"
    await update.message.reply_text(welcome_text)
    # –£–¥–∞–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        await update.message.delete()
    except:
        pass

# –ö–æ–º–∞–Ω–¥–∞ /morning ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
async def morning(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    # –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        await update.message.delete()
    except:
        pass
    
    await send_morning_message(context.bot)
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ —É–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
    sent_msg = await update.message.reply_text("‚úÖ –£—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!")
    asyncio.create_task(delete_message_later(context.bot, update.message.chat_id, sent_msg.message_id, 30))

# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
async def send_morning_message(bot):
    """–§–æ—Ä–º–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
    weather_moscow = await get_weather("–º–æ—Å–∫–≤–∞")
    weather_piter = await get_weather("–ø–∏—Ç–µ—Ä")
    greeting = get_greeting(weather_moscow)
    
    now = datetime.datetime.now(moscow_tz)
    day_name = now.strftime("%A")
    day_names_ru = {
        "Monday": "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫",
        "Tuesday": "–í—Ç–æ—Ä–Ω–∏–∫",
        "Wednesday": "–°—Ä–µ–¥–∞",
        "Thursday": "–ß–µ—Ç–≤–µ—Ä–≥",
        "Friday": "–ü—è—Ç–Ω–∏—Ü–∞",
        "Saturday": "–°—É–±–±–æ—Ç–∞",
        "Sunday": "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"
    }
    day_ru = day_names_ru.get(day_name, day_name)
    current_date = now.strftime("%d.%m.%Y")
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–º—É –¥–Ω—è
    day_theme = DAY_THEMES.get(day_name, {
        "name": day_ru,
        "theme": "üåü –ù–æ–≤—ã–π –¥–µ–Ω—å",
        "message": "–°–µ–≥–æ–¥–Ω—è –±—É–¥–µ—Ç –æ—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å!"
    })
    
    message = f"""
{greeting}

üìÖ –°–µ–≥–æ–¥–Ω—è {current_date}, {day_ru}
{day_theme['theme']}

{day_theme['message']}

üå§ –ü–æ–≥–æ–¥–∞ –≤ –ú–æ—Å–∫–≤–µ: {weather_moscow}
üå§ –ü–æ–≥–æ–¥–∞ –≤ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–µ: {weather_piter}

üèÉ‚Äç‚ôÇÔ∏è –ñ–µ–ª–∞–µ–º –æ—Ç–ª–∏—á–Ω–æ–π –ø—Ä–æ–±–µ–∂–∫–∏! –ù–µ –∑–∞–±—É–¥—å—Ç–µ:
‚Ä¢ –†–∞–∑–º—è—Ç—å—Å—è –ø–µ—Ä–µ–¥ –±–µ–≥–æ–º
‚Ä¢ –í–∑—è—Ç—å –≤–æ–¥—É
‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—É–ª—å—Å
‚Ä¢ –ù–∞—Å–ª–∞–∂–¥–∞—Ç—å—Å—è –±–µ–≥–æ–º!

#—É—Ç—Ä–æ #–±–µ–≥ #–ø—Ä–æ–±–µ–∂–∫–∞
"""
    
    try:
        sent_message = await bot.send_message(chat_id=CHAT_ID, text=message)
        # –£–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —á–∞—Å–æ–≤ (18000 —Å–µ–∫—É–Ω–¥)
        asyncio.create_task(delete_message_later(bot, CHAT_ID, sent_message.message_id, 18000))
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")

# –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ –∑–∞–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
async def delete_message_later(bot, chat_id, message_id, delay: int) -> None:
    """–£–¥–∞–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ–∫—É–Ω–¥"""
    await asyncio.sleep(delay)
    try:
        await bot.delete_message(chat_id=chat_id, message_id=message_id)
    except Exception as e:
        pass

# –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
async def welcome_new_member(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞ (—Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è)"""
    for member in update.message.new_chat_members:
        user_name = member.first_name
        
        now = datetime.datetime.now(moscow_tz)
        day_name = now.strftime("%A")
        day_names_ru = {
            "Monday": "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫",
            "Tuesday": "–í—Ç–æ—Ä–Ω–∏–∫",
            "Wednesday": "–°—Ä–µ–¥–∞",
            "Thursday": "–ß–µ—Ç–≤–µ—Ä–≥",
            "Friday": "–ü—è—Ç–Ω–∏—Ü–∞",
            "Saturday": "–°—É–±–±–æ—Ç–∞",
            "Sunday": "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"
        }
        day_ru = day_names_ru.get(day_name, day_name)
        current_date = now.strftime("%d.%m.%Y")
        
        welcome_messages = [
            f"¬´–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à –±–µ–≥–æ–≤–æ–π –º—É—Ä–∞–≤–µ–π–Ω–∏–∫! –¢—ã —É–∂–µ –≤—ã–±—Ä–∞–ª —Å–≤–æ—é –¥–∏—Å—Ç–∞–Ω—Ü–∏—é: 5 –∫–º –¥–ª—è —Ä–∞–∑–º–∏–Ω–∫–∏, –ø–æ–ª—É–º–∞—Ä–∞—Ñ–æ–Ω –¥–ª—è –¥—É—à–∏ –∏–ª–∏ —Å—Ä–∞–∑—É —É–ª—å—Ç—Ä–∞–º–∞—Ä–∞—Ñ–æ–Ω ‚Äî —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–∞ —á—Ç–æ —Å–ø–æ—Å–æ–±–µ–Ω? –†–∞—Å—Å–∫–∞–∂–∏, –∫–∞–∫–æ–π —É —Ç–µ–±—è —É—Ä–æ–≤–µ–Ω—å: \"–µ—â—ë –¥—ã—à—É\", \"—É–∂–µ –ø–æ—Ç–µ—é\" –∏–ª–∏ \"—è ‚Äî –º–∞—à–∏–Ω–∞\"?¬ª\n\nüìÖ {current_date}, {day_ru}",
            f"¬´–ü—Ä–∏–≤–µ—Ç, –Ω–æ–≤–∏—á–æ–∫! –í –Ω–∞—à–µ–º —á–∞—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ—Å—Ç—ã–µ: –µ—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –±–µ–∂–∞—Ç—å ‚Äî –∏–¥–∏, –µ—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –∏–¥—Ç–∏ ‚Äî –ø–æ–ª–∑–∏, –Ω–æ –≥–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ —Å–¥–∞–≤–∞–π—Å—è! –¢–∞–∫ —Ç—ã –∫—Ç–æ: –Ω–∞—á–∏–Ω–∞—é—â–∏–π —Å—Ç–∞–π–µ—Ä, –æ–ø—ã—Ç–Ω—ã–π –º–∞—Ä–∞—Ñ–æ–Ω–µ—Ü –∏–ª–∏ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π —Ä–µ–∫–æ—Ä–¥—Å–º–µ–Ω –≤ –æ–∂–∏–¥–∞–Ω–∏–∏?¬ª\n\nüìÖ {current_date}, {day_ru}",
            f"¬´–û–≥–æ, –Ω–æ–≤—ã–π –±–µ–≥—É–Ω –Ω–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–µ! –°—Ä–æ—á–Ω–æ –∑–∞–ø–æ–ª–Ω–∏ –∞–Ω–∫–µ—Ç—É: –∏–º—è, –ª—é–±–∏–º—ã–π –º–∞—Ä—à—Ä—É—Ç –∏ —Ü–µ–ª—å –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π –∑–∞–±–µ–≥ (–æ—Ç \"–ø—Ä–æ—Å—Ç–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å\" –¥–æ \"–ø–æ—Ä–≤–∞—Ç—å –≤—Å–µ—Ö –Ω–∞ —Ñ–∏–Ω–∏—à–µ\"). –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–æ–º–∞–Ω–¥—É!¬ª\n\nüìÖ {current_date}, {day_ru}",
            f"¬´–ü—Ä–∏–≤–µ—Ç! –¢—ã –ø–æ–ø–∞–ª –≤ –º–µ—Å—Ç–æ, –≥–¥–µ –∫–∏–ª–æ–º–µ—Ç—Ä—ã —Å—á–∏—Ç–∞—é—Ç –Ω–µ –ø–æ GPS, –∞ –ø–æ —É–ª—ã–±–∫–∞–º. –¢–∞–∫ —á—Ç–æ —Ç—ã: —Ç–æ—Ç, –∫—Ç–æ —Ç–æ–ª—å–∫–æ —É—á–∏—Ç—Å—è –∑–∞–≤—è–∑—ã–≤–∞—Ç—å –∫—Ä–æ—Å—Å–æ–≤–∫–∏, —É–∂–µ –±–µ–≥–∞–µ—Ç –ø–æ —É—Ç—Ä–∞–º –∏–ª–∏ –≥–æ—Ç–æ–≤ –ø—Ä–æ–±–µ–∂–∞—Ç—å –º–∞—Ä–∞—Ñ–æ–Ω –≤ –ø–∏–∂–∞–º–µ?¬ª\n\nüìÖ {current_date}, {day_ru}",
            f"¬´–í–Ω–∏–º–∞–Ω–∏–µ! –í —á–∞—Ç–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω —Å–≤–µ–∂–∏–π –±–µ–≥–æ–≤–æ–π —Ä–µ—Å—É—Ä—Å! –û–±—ä–µ–∫—Ç, –Ω–∞–∑–æ–≤–∏—Ç–µ –≤–∞—à —Å—Ç–∞—Ç—É—Å: \"–µ—â—ë –Ω–µ –ø—Ä–æ–±–µ–∂–∞–ª –ø–µ—Ä–≤—ã–π –∫–º\", \"—É–∂–µ –≤—Ç—è–Ω—É–ª—Å—è\" –∏–ª–∏ \"—è —Ç—É—Ç –≥–ª–∞–≤–Ω—ã–π –ø–µ–π—Å–º–µ–π–∫–µ—Ä\"?¬ª\n\nüìÖ {current_date}, {day_ru}",
            f"¬´–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–µ–≥–æ–≤—É—é —Å–µ–º—å—é! –£ –Ω–∞—Å —Ç—É—Ç —Ç—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: –Ω–æ–≤–∏—á–∫–∏ (–∫–æ—Ç–æ—Ä—ã–µ –±–æ—è—Ç—Å—è —Å–ª–æ–≤–∞ \"–º–∞—Ä–∞—Ñ–æ–Ω\"), –ª—é–±–∏—Ç–µ–ª–∏ (–∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –∑–Ω–∞—é—Ç, —á—Ç–æ —Ç–∞–∫–æ–µ –∫—Ä–µ–ø–∞—Ç—É—Ä–∞) –∏ –ª–µ–≥–µ–Ω–¥—ã (–∫–æ—Ç–æ—Ä—ã–µ –±–µ–≥–∞—é—Ç –¥–∞–∂–µ –≤–æ —Å–Ω–µ). –ö –∫–∞–∫–æ–π –æ—Ç–Ω–æ—Å–∏—à—å—Å—è —Ç—ã?¬ª\n\nüìÖ {current_date}, {day_ru}",
            f"¬´–≠–π, –Ω–æ–≤–µ–Ω—å–∫–∏–π! –ü—Ä–∏–∑–Ω–∞–≤–∞–π—Å—è: —Ç—ã —Ç—É—Ç —á—Ç–æ–±—ã —Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∫–æ—Ä–¥—ã, –∏—Å–∫–∞—Ç—å –º–æ—Ç–∏–≤–∞—Ü–∏—é –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–±–æ–ª—Ç–∞—Ç—å –æ –∫—Ä–æ—Å—Å–æ–≤–∫–∞—Ö? –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ ‚Äî –±–µ–≥–∏ –∫ –Ω–∞–º, —É –Ω–∞—Å –≤–µ—Å–µ–ª–æ!¬ª\n\nüìÖ {current_date}, {day_ru}",
            f"¬´–ü—Ä–∏–≤–µ—Ç-–ø—Ä–∏–≤–µ—Ç! –¢—ã —Å–µ–π—á–∞—Å –Ω–∞ —ç—Ç–∞–ø–µ: \"–∫—Ç–æ –≤—Å–µ —ç—Ç–∏ –±–µ–≥—É–Ω—ã?\", \"–æ, —Ç—É—Ç –∫–ª–∞—Å—Å–Ω—ã–µ —Ä–µ–±—è—Ç–∞\" –∏–ª–∏ \"—è –∑–Ω–∞—é –≤—Å–µ —Ç—Ä–∞—Å—Å—ã, –Ω–æ –Ω–∏–∫–æ–º—É –Ω–µ —Å–∫–∞–∂—É\"? –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à –∑–∞–±–µ–≥!¬ª\n\nüìÖ {current_date}, {day_ru}",
            f"¬´–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫? –û—Ç–ª–∏—á–Ω–æ! –£ –Ω–∞—Å –µ—Å—Ç—å —Ç—Ä–∏ —É—Ä–æ–≤–Ω—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: –ª—ë–≥–∫–∏–π (–ø—Ä–æ—Å—Ç–æ –≤—ã–π—Ç–∏ –Ω–∞ –ø—Ä–æ–±–µ–∂–∫—É), —Å—Ä–µ–¥–Ω–∏–π (–Ω–µ —Å–æ–π—Ç–∏ —Å –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏) –∏ —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π (—É–ª—ã–±–∞—Ç—å—Å—è –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–∏–ª–æ–º–µ—Ç—Ä–∞—Ö). –ö–∞–∫–æ–π –≤—ã–±–∏—Ä–∞–µ—à—å?¬ª\n\nüìÖ {current_date}, {day_ru}",
            f"¬´–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç, –≥–¥–µ –∫–∏–ª–æ–º–µ—Ç—Ä—ã ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ü–∏—Ñ—Ä—ã, –∞ –∏—Å—Ç–æ—Ä–∏–∏! –¢—ã –∫—Ç–æ: —Ç–æ—Ç, –∫—Ç–æ —Ç–æ–ª—å–∫–æ –º–µ—á—Ç–∞–µ—Ç –æ –ø–µ—Ä–≤–æ–º –∑–∞–±–µ–≥–µ, —É–∂–µ —Å–æ–±–∏—Ä–∞–µ—Ç –º–µ–¥–∞–ª–∏ –∏–ª–∏ –≥–æ—Ç–æ–≤ –ø—Ä–æ–±–µ–∂–∞—Ç—å 42 –∫–º —Ä–∞–¥–∏ —à—É—Ç–∫–∏?¬ª\n\nüìÖ {current_date}, {day_ru}",
        ]
        
        welcome_text = random.choice(welcome_messages)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        await update.message.reply_text(welcome_text)

# –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ 06:00
async def morning_scheduler(bot):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Ä–µ–º—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ 06:00 –ø–æ –ú–æ—Å–∫–≤–µ"""
    while True:
        now_moscow = datetime.datetime.now(moscow_tz)
        current_hour = now_moscow.hour
        current_minute = now_moscow.minute
        
        if current_hour == 6 and current_minute == 0:
            await send_morning_message(bot)
            await asyncio.sleep(60)
        else:
            await asyncio.sleep(30)

async def post_init(application: Application) -> None:
    """–ó–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞"""
    asyncio.create_task(morning_scheduler(application.bot))
    print("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")

def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    flask_thread = threading.Thread(target=run_flask, daemon=True)
    flask_thread.start()
    print("üåê Flask –∑–∞–ø—É—â–µ–Ω")
    
    application = Application.builder()\
        .token(BOT_TOKEN)\
        .post_init(post_init)\
        .build()
    
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("morning", morning))
    application.add_handler(MessageHandler(filters.StatusUpdate.NEW_CHAT_MEMBERS, welcome_new_member))
    
    print("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω")
    application.run_polling()

if __name__ == "__main__":
    main()
